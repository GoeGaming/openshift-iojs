#!/bin/bash

ver=${OPENSHIFT_NODEJS_VERSION}

zfile="node-${ver}-linux-x64.tar.gz"
zlink="http://nodejs.org/dist/${ver}/${zfile}"

#  Download and extract the gzipped tarball.
dldir="$OPENSHIFT_TMP_DIR/downloads"
mkdir -p "$dldir"

if ! curl -L -o "$dldir/$zfile" "$zlink"; then
  echo "  - ERROR  -- download failed for $zlink"
  echo "  - download uri = $dldir/$zfile"
  return 1
fi

cd "$dldir"
mkdir -p tmp && tar -xf "$zfile" -C tmp --strip-components 1

npm -g ls | grep -v 'npm@' | awk '/@/ {print $2}' | awk -F@ '{print $1}' | xargs npm -g rm
rm -rf ${OPENSHIFT_NODEJS_PATH}/*
mv -f tmp/* ${OPENSHIFT_NODEJS_PATH}

echo "  - Done installing Node.js version $ver"

npm install ${OPENSHIFT_NPM_GLOBAL} -g
