#!/bin/bash

function status() {
    echo "Status:"
    node -v
    npm -v
}

function start() {
    logf="$OPENSHIFT_NODEJS_LOG_DIR/node.log"
    if [ -f "${OPENSHIFT_REPO_DIR}package.json" ]; then
        cd ${OPENSHIFT_REPO_DIR}
        npm start >> $logf 2>&1 &
    fi
}

function stop() {
    killall node
}

function restart() {
    stop
    start
}

function reload() {
    echo > ${OPENSHIFT_NODEJS_VERSION} > ${OPENSHIFT_NODEDIY_DIR}env/OPENSHIFT_NODEJS_VERSION
}

function tidy() {
  client_message "Emptying log dir: $OPENSHIFT_NODEJS_LOG_DIR"
  shopt -s dotglob
  rm -rf $OPENSHIFT_NODEJS_LOG_DIR/*
  rm -rf ${OPENSHIFT_NODEJS_DIR}tmp/*
}

#
#  main():
#

# Ensure arguments.
if ! [ $# -eq 1 ]; then
    echo "Usage: $0 [start|restart|graceful|graceful-stop|stop|status]"
    exit 1
fi

# Source utility functions.
source $OPENSHIFT_CARTRIDGE_SDK_BASH

# Handle commands.
case "$1" in
    start)               start       ;;
    restart|graceful)    restart     ;;
    graceful-stop|stop)  stop        ;;
    status)              status      ;;
    reload)              reload      ;;
    tidy)                tidy        ;;
    *) exit 0;
esac

